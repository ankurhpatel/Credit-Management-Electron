<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💳 IT Services Credit Management</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header class="app-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 30px;">
            <div class="header-logo" style="display: flex; align-items: center; gap: 15px;">
                <img id="headerLogo" style="height: 50px; width: auto; display: none; object-fit: contain;">
                <div>
                    <h1>💳 IT Services Management</h1>
                    <p>Proactive POS & Inventory System</p>
                </div>
            </div>

            <!-- Global Support Search -->
            <div class="support-search-container" style="position: relative; width: 400px;">
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="globalSupportSearch" placeholder="🔍 Quick Support: Enter MAC, Phone, or Name..." 
                           style="flex: 1; padding: 10px; border-radius: 8px; border: 2px solid #667eea; outline: none;"
                           oninput="SupportUI.search()">
                    <button onclick="SupportUI.clear()" class="btn-clear" style="padding: 5px 15px;">✕</button>
                </div>
                <!-- Search Result Dropdown -->
                <div id="supportSearchResults" class="support-results-dropdown" style="display: none;"></div>
            </div>
        </header>

        <nav class="tab-nav">
            <button class="tab-btn" onclick="showTab('pos')">🛒 New Sale (POS)</button>
            <button class="tab-btn active" onclick="showTab('dashboard')">📊 Dashboard</button>
            <button class="tab-btn" onclick="showTab('pnl')">📈 P&L Statement</button>
            <button class="tab-btn" onclick="showTab('credits')">📦 Inventory & Stock</button>
            <button class="tab-btn" onclick="showTab('customers')">👥 Customer Management</button>
            <button class="tab-btn" onclick="showTab('vendors')">🏭 Vendor Management</button>
            <button class="tab-btn" onclick="showTab('business')">💼 Business Management</button>
            <button class="tab-btn" onclick="showTab('transactions')">📊 Transaction History</button>
            <button class="tab-btn" onclick="showTab('settings')">⚙️ Settings</button>
        </nav>

        <!-- POS Tab -->
        <div id="pos" class="tab-content">
            <div class="pos-layout">
                <!-- Left Side: Catalog -->
                <div class="pos-left">
                    <div class="pos-section-header">
                        <h3 style="margin-right: 20px; white-space: nowrap;">📦 Catalog</h3>
                        <div style="position: relative; flex: 1; max-width: 500px; margin-right: 10px;">
                            <input type="text" id="posServiceSearch" placeholder="🔍 Search items by name, type, or vendor..."
                                   oninput="POSUI.filterServices()" 
                                   style="width: 100%; padding: 12px 45px 12px 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                            <button onclick="document.getElementById('posServiceSearch').value=''; POSUI.filterServices();"
                                    id="posClearSearchBtn"
                                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #edf2f7; border: none; color: #718096; cursor: pointer; font-size: 16px; width: 28px; height: 28px; border-radius: 50%; display: none; align-items: center; justify-content: center; transition: all 0.2s;"
                                    title="Clear search">✕</button>
                        </div>
                    </div>
                    <div id="posServiceCatalog" class="pos-catalog-container">
                        <!-- Services will be injected here -->
                    </div>
                </div>

                <!-- Right Side: Cart/Checkout -->
                <div class="pos-right">
                    <div class="pos-panel customer-panel">
                        <h3>👤 Customer</h3>
                        <div class="customer-search-wrapper">
                            <input type="text" id="posCustomerSearch" placeholder="🔍 Search Customer (Name/Email/Phone)" 
                                   oninput="POSUI.searchCustomers()" onfocus="POSUI.showCustomerDropdown()">
                            <div id="posCustomerDropdown" class="search-dropdown" style="display: none;"></div>
                        </div>
                        <div id="posSelectedCustomer" class="selected-customer-card" style="display: none;">
                            <div class="selected-customer-info">
                                <span class="customer-name-display"></span>
                                <small class="customer-email-display"></small>
                            </div>
                            <button onclick="POSUI.clearCustomer()" class="btn-icon">✕</button>
                        </div>
                        
                        <!-- NEW: Customer Intelligence Panel -->
                        <div id="posCustomerIntelligence" class="customer-intel-panel" style="display: none;">
                            <div id="posIntelAlerts"></div>
                            <div class="intel-section">
                                <label>📝 Profile Notes:</label>
                                <div id="posIntelNotes" class="intel-notes-box"></div>
                            </div>
                            <div class="intel-section">
                                <label>💰 Last Paid:</label>
                                <span id="posIntelLastPrice">-</span>
                            </div>
                        </div>

                        <button onclick="showTab('customers'); showCustomerTab('add-customer')" class="btn-small btn-secondary" style="margin-top: 5px; width: 100%;">+ New Customer</button>
                    </div>

                    <div class="pos-panel cart-panel">
                        <h3>🛒 Shopping Cart</h3>
                        
                        <div id="posCartItems" class="cart-items-list">
                            <!-- Items will be injected here -->
                            <div class="placeholder-text">Click services on the left to add to cart</div>
                        </div>

                        <div class="cart-footer">
                            <div class="cart-controls-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label>📑 Order Status:</label>
                                    <select id="posOrderStatus" class="form-select" style="padding: 8px;">
                                        <option value="Open" selected>📂 Open (Pending)</option>
                                        <option value="Closed">✅ Closed (Fulfilled)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>💳 Payment Type:</label>
                                    <select id="posPaymentType" class="form-select" style="padding: 8px;">
                                        <option value="Other" selected>Other</option>
                                        <option value="Cash">💵 Cash</option>
                                        <option value="Bank Transfer">🏦 Bank Transfer</option>
                                        <option value="Card">💳 Credit/Debit Card</option>
                                        <option value="Zelle/Venmo">📱 Zelle / Venmo</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>💰 Payment Status:</label>
                                    <select id="posPaymentStatus" class="form-select" style="padding: 8px;">
                                        <option value="Pending" selected>⏳ Pending / Unpaid</option>
                                        <option value="Paid">✅ Paid</option>
                                        <option value="Advance">🎁 Advance Payment</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>🔢 Transaction ID (Ref):</label>
                                    <input type="text" id="posTransactionIdRef" placeholder="External Ref #" style="padding: 8px;">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>📝 Order Notes:</label>
                                <input type="text" id="posOrderNotes" placeholder="Optional notes for this order">
                            </div>
                            
                            <div class="price-display cart-total-display" style="background: #1a202c; color: white; padding: 20px; border-radius: 12px; margin: 20px 0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                <span style="font-size: 18px;">Grand Total:</span>
                                <div style="display: flex; align-items: center;">
                                    <span style="font-size: 24px; font-weight: 800; color: #48bb78; margin-right: 5px;">$</span>
                                    <input type="number" id="posCartTotal" value="0.00" step="0.01" 
                                           onchange="POSUI.updateCartTotal(this.value)"
                                           style="background: transparent; border: none; border-bottom: 2px solid #48bb78; color: #48bb78; font-size: 28px; font-weight: 800; width: 140px; text-align: right; outline: none;">
                                </div>
                            </div>

                            <button id="posCheckoutBtn" class="btn-primary checkout-btn" onclick="POSUI.processSale()">
                                💳 Complete Bundle Sale & Print
                            </button>
                            <button class="btn-small btn-secondary" onclick="POSUI.resetForm()" style="width: 100%; margin-top: 10px;">🗑️ Clear Cart</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Low Stock Threshold Modal -->
        <div id="thresholdModal" class="modal-backdrop" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>⚙️ Configure Low Stock Alert</h3>
                    <button onclick="CreditsUI.closeThresholdModal()" class="btn-icon">✕</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="thresholdServiceId">

                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">Service</div>
                        <div id="thresholdServiceName" style="font-size: 18px; color: #2d3748;"></div>
                        <div style="margin-top: 8px; font-size: 14px; color: #718096;">
                            Current Stock: <strong id="thresholdCurrentStock"></strong> units
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Alert me when stock falls below:</label>
                        <input type="number" id="thresholdInput" min="0"
                               oninput="CreditsUI.updateThresholdPreview(parseInt(document.getElementById('thresholdCurrentStock').textContent), parseInt(this.value) || 0)"
                               style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: 6px;">
                        <div style="font-size: 13px; color: #718096; margin-top: 8px;">
                            💡 <strong>Tip:</strong> Set to 0 for items you can restock quickly (e.g., Firestick from Best Buy). Set to 50-100 for services that need advance planning.
                        </div>
                    </div>

                    <div id="thresholdPreview" style="margin-top: 20px;"></div>
                </div>
                <div class="modal-footer">
                    <button onclick="CreditsUI.closeThresholdModal()" class="btn-secondary">Cancel</button>
                    <button onclick="CreditsUI.saveThreshold()" class="btn-primary">💾 Save Threshold</button>
                </div>
            </div>
        </div>

        <!-- Custom Item / Misc Modal -->
        <div id="customItemModal" class="modal-backdrop" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>✨ Add Custom / Misc Item</h3>
                    <button onclick="POSUI.closeCustomItemModal()" class="btn-icon">✕</button>
                </div>
                <div class="modal-body">
                    <form onsubmit="POSUI.addCustomItemToCart(event)">
                        <div class="form-group">
                            <label>📝 Item Description / Name:</label>
                            <input type="text" id="customItemName" required placeholder="e.g. Service Fee, Refund, Old Cable..." 
                                   style="font-size: 16px; padding: 10px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>💰 Price ($):</label>
                                <input type="number" id="customItemPrice" step="0.01" required placeholder="0.00"
                                       style="font-size: 16px; padding: 10px;">
                                <small>Use negative (-) for refunds</small>
                            </div>
                            <div class="form-group">
                                <label>📊 Quantity / Months:</label>
                                <input type="number" id="customItemQty" value="1" min="1" required
                                       style="font-size: 16px; padding: 10px;">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>📦 Item Type:</label>
                            <select id="customItemType" class="form-select" style="padding: 10px;">
                                <option value="subscription">📅 Service / Labor</option>
                                <option value="hardware">🔌 Hardware / Physical</option>
                                <option value="fee">💰 Fee / Adjustment</option>
                            </select>
                        </div>

                        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" onclick="POSUI.closeCustomItemModal()" class="btn-secondary">Cancel</button>
                            <button type="submit" class="btn-primary">➕ Add to Order</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin-bottom: 0; border-bottom: none;">📊 Dashboard & Analytics</h2>
                <div class="filters" style="display: flex; gap: 10px; align-items: center;">
                    <select id="dashboardFilterMonth" onchange="DashboardUI.refreshStats()" class="form-select" style="padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <option value="all">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>

                    <select id="dashboardFilterYear" onchange="DashboardUI.refreshStats()" class="form-select" style="padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <option value="all">All Years</option>
                    </select>
                </div>
            </div>

            <!-- TIER 1: KPI CARDS -->
            <div class="dashboard-kpi-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                <div class="stat-card" style="border-left: 4px solid #667eea; padding: 20px;">
                    <div class="stat-label" style="font-size: 13px; color: #718096; margin-bottom: 5px;">Total Revenue</div>
                    <div class="stat-number" id="kpiRevenue" style="font-size: 28px; color: #2d3748;">$0.00</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #48bb78; padding: 20px;">
                    <div class="stat-label" style="font-size: 13px; color: #718096; margin-bottom: 5px;">Gross Profit</div>
                    <div class="stat-number" id="kpiGrossProfit" style="font-size: 28px; color: #2d3748;">$0.00</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #ed8936; padding: 20px;">
                    <div class="stat-label" style="font-size: 13px; color: #718096; margin-bottom: 5px;">Net Margin</div>
                    <div class="stat-number" id="kpiMargin" style="font-size: 28px; color: #2d3748;">0%</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #4299e1; padding: 20px;">
                    <div class="stat-label" style="font-size: 13px; color: #718096; margin-bottom: 5px;">Total Orders</div>
                    <div class="stat-number" id="kpiOrders" style="font-size: 28px; color: #2d3748;">0</div>
                </div>
            </div>

            <!-- TIER 2: CHARTS ROW -->
            <div class="dashboard-charts-row" style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
                <!-- Profit Trend -->
                <div class="chart-container" style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">📈 Profit Trends</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>

                <!-- Revenue Mix -->
                <div class="chart-container" style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">🍩 Revenue Mix</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="mixChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TIER 3: LISTS ROW -->
            <div class="dashboard-lists-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Top 5 Performers -->
                <div class="list-panel" style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">🏆 Top 5 Profitable Items</h3>
                    <table class="simple-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #edf2f7; text-align: left;">
                                <th style="padding: 8px; font-size: 12px; color: #718096;">Item</th>
                                <th style="padding: 8px; font-size: 12px; color: #718096; text-align: right;">Units</th>
                                <th style="padding: 8px; font-size: 12px; color: #718096; text-align: right;">Profit</th>
                            </tr>
                        </thead>
                        <tbody id="topItemsList"></tbody>
                    </table>
                </div>

                <!-- Action Items -->
                <div class="list-panel" style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">⚠️ Action Needed</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="font-size: 14px; color: #e53e3e; margin: 0;">📉 Low Stock Alerts</h4>
                            <a href="#" onclick="showTab('credits'); return false;" style="font-size: 12px; color: #667eea; text-decoration: none;">Manage Inventory →</a>
                        </div>
                        <div id="lowStockList"></div>
                    </div>
                    
                    <div>
                        <h4 style="font-size: 14px; color: #ed8936; margin-bottom: 10px;">📅 Expiring Soon</h4>
                        <div id="expiringList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- P&L Tab (FIXED) -->
        <div id="pnl" class="tab-content">
            <h2>📈 Profit & Loss Statement</h2>

            <div class="pnl-tabs">
                <button class="tab-button active" onclick="showPLTab('monthly')">📅 Monthly</button>
                <button class="tab-button" onclick="showPLTab('yearly')">📆 Yearly</button>
                <button class="tab-button" onclick="showPLTab('lifetime'); loadLifetimePL();">🏢 Lifetime</button>
            </div>

            <!-- Monthly P&L Tab -->
            <div id="monthly" class="pnl-tab-content active">
                <h3>Monthly P&L Analysis</h3>
                <form onsubmit="loadMonthlyPL(event)" class="form-inline">
                    <div class="form-group">
                        <label>📅 Select Month:</label>
                        <select id="selectMonth" required>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>📆 Select Year:</label>
                        <select id="selectYear" required></select>
                    </div>
                    <button type="submit" class="btn-primary">📊 Load Monthly P&L</button>
                </form>
                <div id="monthlyPLResult" class="results-container"></div>
            </div>

            <!-- Yearly P&L Tab -->
            <div id="yearly" class="pnl-tab-content">
                <h3>Yearly P&L Analysis</h3>
                <form onsubmit="loadYearlyPL(event)" class="form-inline">
                    <div class="form-group">
                        <label>📆 Select Year:</label>
                        <select id="selectYearOnly" required></select>
                    </div>
                    <button type="submit" class="btn-primary">📊 Load Yearly P&L</button>
                </form>
                <div id="yearlyPLResult" class="results-container"></div>
            </div>

            <!-- Lifetime P&L Tab -->
            <div id="lifetime" class="pnl-tab-content">
                <h3>🏢 All-Time Business Performance</h3>
                <div id="lifetimePLResult" class="results-container"></div>
            </div>

            <!-- Credit Balances in P&L Tab -->
            <h3>💳 Current Credit Balances</h3>
            <div id="creditBalancesList" class="credit-balances"></div>
        </div>

        <!-- Credits Tab -->
        <div id="credits" class="tab-content">
            <h2>📦 Inventory & Stock Levels</h2>
            <div id="creditBalancesView" class="credit-balances"></div>
        </div>

        <!-- Customer Management Tab (ENHANCED) -->
        <div id="customers" class="tab-content">
            <h2>👥 Customer Management</h2>

            <!-- Sub-tabs for Customer Management -->
            <div class="customer-tabs">
                <button class="tab-button active" onclick="showCustomerTab('customer-list')">📋 Customer List</button>
                <button class="tab-button" onclick="showCustomerTab('customer-profile')" id="customerProfileTab" style="display: none;">👤 Customer Profile</button>
                <button class="tab-button" onclick="showCustomerTab('add-customer')">➕ Add Customer</button>
                <button class="tab-button" onclick="showCustomerTab('add-subscription')">📝 Add Subscription</button>
                <button class="tab-button" onclick="showCustomerTab('edit-customer')">✏️ Edit Customer</button>
            </div>

            <!-- Customer List Sub-tab -->
            <div id="customer-list" class="customer-tab-content active">
                <h3>📋 Customer Directory</h3>

                <!-- Search Bar -->
                <div class="search-container">
                    <div class="search-bar">
                        <input type="text" id="customerSearch" placeholder="🔍 Search customers by name, email, phone, or ID..."
                               oninput="filterCustomers()">
                        <button onclick="clearCustomerSearch()" class="btn-clear">✕ Clear</button>
                    </div>
                    <div class="search-stats">
                        <span id="customerCount">0</span> customers found
                    </div>
                </div>

                <!-- Customer List Display -->
                <div id="customerListDisplay" class="customer-list"></div>
            </div>

            <!-- Customer Profile Sub-tab -->
            <div id="customer-profile" class="customer-tab-content">
                <div id="customerProfileContent">
                    <div class="loading-message">Select a customer to view their profile</div>
                </div>
            </div>

            <!-- Add Customer Sub-tab -->
            <div id="add-customer" class="customer-tab-content">
                <h3>➕ Add New Customer</h3>
                <form onsubmit="addCustomer(event)" class="form">
                    <div class="form-group">
                        <label>👤 Customer Name:</label>
                        <input type="text" name="name" required maxlength="100" placeholder="Enter customer name">
                    </div>
                    <div class="form-group">
                        <label>📧 Email Address:</label>
                        <input type="email" name="email" required maxlength="100" placeholder="customer@example.com">
                    </div>
                    <div class="form-group">
                        <label>📱 Phone Number:</label>
                        <input type="tel" name="phone" maxlength="20" placeholder="+1-555-123-4567">
                    </div>
                    <div class="form-group">
                        <label>🏠 Address:</label>
                        <textarea name="address" rows="3" maxlength="200" placeholder="Customer address (optional)"></textarea>
                    </div>
                    <div class="form-group">
                        <label>📝 Internal Business Notes (Private):</label>
                        <textarea name="internal_notes" rows="2" maxlength="500" placeholder="e.g. Needs video call setup, always asks for discount, etc."></textarea>
                        <small>These notes are only visible to you in the POS and management tabs.</small>
                    </div>
                    <button type="submit" class="btn-primary">Add Customer</button>
                </form>
            </div>

            <!-- Add Subscription Sub-tab (ENHANCED) -->
            <div id="add-subscription" class="customer-tab-content">
                <h3>📝 Add New Subscription</h3>
                <form onsubmit="addSubscription(event)" class="form">
                    <div class="form-group">
                        <label>👤 Select Customer:</label>
                        <div class="customer-search-dropdown">
                            <input type="text" id="customerSearchInput" placeholder="🔍 Type to search customers by name, email, phone, ID..."
                                   oninput="searchCustomersForSubscription()" onfocus="showCustomerDropdown()">
                            <input type="hidden" name="customerID" id="selectedCustomerID" required>
                            <div id="customerDropdown" class="search-dropdown" style="display: none;">
                                <div id="customerDropdownList"></div>
                            </div>
                        </div>
                        <small>Or <a href="#" onclick="showCustomerTab('add-customer')">add a new customer first</a></small>
                    </div>

                    <div class="form-group">
                        <label>🔧 Service Name:</label>
                        <input type="text" name="serviceName" value="IT App Services" readonly>
                        <small>Service name is always "IT App Services"</small>
                    </div>

                    <div class="form-group">
                        <label>📍 Classification (Room/Location):</label>
                        <input type="text" name="classification" placeholder="living room, bedroom, office, etc." maxlength="50">
                        <small>Specify room, location, or area for this service</small>
                    </div>
                    <!-- Add this in the Add Subscription form, after the classification field -->
                    <div class="form-group">
                        <label>🖥️ Device MAC Address:</label>
                        <input type="text" name="macAddress"
                               placeholder="00:1A:2B:3C:4D:5E (optional)"
                               pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$|^$"
                               maxlength="17"
                               title="Format: XX:XX:XX:XX:XX:XX or XX-XX-XX-XX-XX-XX">
                        <small>MAC address of the TV/device (optional) - helps identify specific device</small>
                    </div>

                    <div class="form-group">
                        <label>🔧 Vendor Service:</label>
                        <select name="vendorServiceName" id="vendorServiceSelectSub" required>
                            <option value="">Choose a service...</option>
                        </select>
                        <small>Select the service you're providing to the customer</small>
                    </div>

                    <div class="form-group">
                        <label>📅 Start Date:</label>
                        <input type="date" name="startDate" required>
                    </div>

                    <div class="form-group">
                        <label>📊 Credits to Use:</label>
                        <input type="number" name="creditsSelected" min="1" max="60" required onchange="calculateExpirationDateSub()">
                        <small>Each credit = 1 month of service</small>
                    </div>

                    <div class="form-group">
                        <label>⏰ Expiration Date:</label>
                        <input type="date" name="expirationDate" readonly>
                    </div>

                    <div class="form-group">
                        <label>💰 Amount Paid ($):</label>
                        <input type="number" name="amountPaid" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label>📝 Notes:</label>
                        <textarea name="notes" rows="3" maxlength="500" placeholder="Optional notes about this subscription"></textarea>
                    </div>

                    <div class="form-group">
                        <label>📊 Status:</label>
                        <select name="status">
                            <option value="active">✅ Active</option>
                            <option value="expired">❌ Expired</option>
                            <option value="cancelled">🚫 Cancelled</option>
                        </select>
                    </div>

                    <button type="submit" class="btn-primary">Add Subscription & Use Credits</button>
                </form>
            </div>

            <!-- Edit Customer Sub-tab (ENHANCED) -->
            <div id="edit-customer" class="customer-tab-content">
                <h3>✏️ Edit Customer</h3>

                <div class="form-group">
                    <label>👤 Select Customer to Edit:</label>
                    <select id="editCustomerSelect" onchange="loadCustomerForEdit()">
                        <option value="">Choose a customer to edit...</option>
                    </select>
                </div>

                <div id="editCustomerForm" style="display: none;">
                    <form onsubmit="updateCustomer(event)" class="form">
                        <input type="hidden" name="customerId" id="editCustomerId">

                        <div class="form-group">
                            <label>👤 Customer Name:</label>
                            <input type="text" name="name" id="editCustomerName" required maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>📧 Email Address:</label>
                            <input type="email" name="email" id="editCustomerEmail" required maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>📱 Phone Number:</label>
                            <input type="tel" name="phone" id="editCustomerPhone" maxlength="20">
                        </div>
                        <div class="form-group">
                            <label>🏠 Address:</label>
                            <textarea name="address" id="editCustomerAddress" rows="3" maxlength="200"></textarea>
                        </div>
                        <div class="form-group">
                            <label>📝 Internal Business Notes (Private):</label>
                            <textarea name="internal_notes" id="editCustomerInternalNotes" rows="2" maxlength="500"></textarea>
                        </div>
                        <div class="form-group">
                            <label>📊 Status:</label>
                            <select name="status" id="editCustomerStatus">
                                <option value="active">✅ Active</option>
                                <option value="inactive">❌ Inactive</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Update Customer</button>
                            <button type="button" onclick="cancelEdit()" class="btn-secondary">Cancel</button>
                            <button type="button" onclick="viewCustomerTransactions()" class="btn-info">📄 View Receipts</button>
                            <button type="button" onclick="deleteCustomer()" class="btn-danger">🗑️ Delete Customer</button>
                        </div>
                    </form>
                </div>

                <!-- Customer Transaction History (when editing) -->
                <div id="customerTransactionHistory" style="display: none;">
                    <h4>📄 Transaction History</h4>
                    <div id="editCustomerTransactions" class="customer-transactions"></div>
                </div>
            </div>
        </div>

        <!-- Vendor Management Tab -->
        <div id="vendors" class="tab-content">
            <h2>🏭 Vendor Management</h2>

            <!-- Sub-tabs for Vendor Management -->
            <div class="vendor-tabs">
                <button class="tab-button active" onclick="showVendorTab('vendor-list')">📋 Vendor List</button>
                <button class="tab-button" onclick="showVendorTab('add-vendor')">➕ Add Vendor</button>
                <button class="tab-button" onclick="showVendorTab('vendor-services')">🔧 Service Catalog</button>
                <button class="tab-button" onclick="showVendorTab('purchase-credits')">💸 Add Stock / Purchase</button>
            </div>

            <!-- Vendor List Sub-tab -->
            <div id="vendor-list" class="vendor-tab-content active">
                <h3>📋 Vendor Directory</h3>

                <!-- Search Bar for Vendors -->
                <div class="search-container">
                    <div class="search-bar">
                        <input type="text" id="vendorSearch" placeholder="🔍 Search vendors by name, email, or description..."
                               oninput="filterVendors()">
                        <button onclick="clearVendorSearch()" class="btn-clear">✕ Clear</button>
                    </div>
                    <div class="search-stats">
                        <span id="vendorCount">0</span> vendors found
                    </div>
                </div>

                <!-- Vendor List Display -->
                <div id="vendorListDisplay" class="vendor-list"></div>
            </div>

            <!-- Add Vendor Sub-tab -->
            <div id="add-vendor" class="vendor-tab-content">
                <h3>➕ Add New Vendor</h3>
                <form onsubmit="addVendor(event)" class="form">
                    <div class="form-group">
                        <label>🏭 Vendor Name:</label>
                        <input type="text" name="name" required maxlength="100" placeholder="Enter vendor name">
                    </div>
                    <div class="form-group">
                        <label>📧 Contact Email:</label>
                        <input type="email" name="contactEmail" maxlength="100" placeholder="contact@vendor.com">
                    </div>
                    <div class="form-group">
                        <label>📱 Contact Phone:</label>
                        <input type="tel" name="contactPhone" maxlength="20" placeholder="+1-555-123-4567">
                    </div>
                    <div class="form-group">
                        <label>📝 Description:</label>
                        <textarea name="description" rows="3" maxlength="500" placeholder="Brief description of vendor services"></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Add Vendor</button>
                </form>
            </div>

            <!-- Vendor Services Sub-tab -->
            <div id="vendor-services" class="vendor-tab-content">
                <h3>🔧 Service Catalog Management</h3>

                <!-- Service List Display -->
                <div id="vendorServicesList" class="services-list"></div>

                <div class="service-note">
                    <strong>Note:</strong> Services are catalog entries. Prices are entered per transaction when purchasing credits.
                </div>

                <!-- Add Service Form -->
                <h4>Add Item to Catalog</h4>
                <form onsubmit="addVendorService(event)" class="form">
                    <div class="form-group">
                        <label>🏭 Select Vendor:</label>
                        <select name="vendorID" id="serviceVendorSelect" required>
                            <option value="">Choose a vendor...</option>
                        </select>
                        <small>Or <a href="#" onclick="showVendorTab('add-vendor')">add a new vendor first</a></small>
                    </div>
                    <div class="form-group">
                        <label>📦 Item Type:</label>
                        <select name="itemType" id="catalogItemType" required onchange="VendorsUI.updateCatalogLabels()">
                            <option value="subscription">📅 IT Service (Time-based)</option>
                            <option value="hardware">🔌 Hardware (Physical Product)</option>
                            <option value="fee">💰 Fee / Shipping</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="catalogNameLabel">🔧 Service Name:</label>
                        <input type="text" name="serviceName" required maxlength="100" placeholder="Enter name">
                    </div>
                    <div class="form-row" style="display: flex; gap: 15px;">
                        <div class="form-group" style="flex: 1;">
                            <label>💸 Cost Price ($):</label>
                            <input type="number" name="costPrice" step="0.01" min="0" placeholder="0.00">
                            <small>What you paid for it.</small>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label id="catalogPriceLabel">💰 Sales Price ($):</label>
                            <input type="number" name="defaultPrice" step="0.01" min="0" placeholder="0.00">
                            <small id="catalogPriceHelp">Standard selling price.</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>📝 Description:</label>
                        <textarea name="description" rows="2" maxlength="500" placeholder="Brief description"></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Add to Catalog</button>
                </form>
            </div>

            <!-- Purchase Credits Sub-tab -->
            <div id="purchase-credits" class="vendor-tab-content">
                <h3>💸 Add Inventory Stock</h3>

                <div class="currency-note">
                    <strong>💱 Currency Note:</strong> Convert your purchase amount to USD before entering. This helps maintain consistent profit calculations.
                </div>

                <!-- Purchase Credits Form -->
                <h4>Record Product/Service Purchase</h4>
                <form onsubmit="purchaseCredits(event)" class="form">
                    <div class="form-group">
                        <label>🏭 Select Vendor:</label>
                        <select name="vendorID" id="purchaseVendorSelect" required onchange="loadServicesForPurchaseVendor()">
                            <option value="">Choose a vendor...</option>
                        </select>
                        <small>Or <a href="#" onclick="showVendorTab('add-vendor')">add a new vendor first</a></small>
                    </div>
                    <div class="form-group">
                        <label>🔧 Select Product/Service:</label>
                        <select name="serviceName" id="purchaseServiceSelect" required onchange="VendorsUI.updatePurchaseLabels()">
                            <option value="">Choose an item...</option>
                        </select>
                        <small>Item must exist in catalog. <a href="#" onclick="showVendorTab('vendor-services')">Add to catalog</a> if needed.</small>
                    </div>
                    <div class="form-group">
                        <label>📅 Purchase Date:</label>
                        <input type="date" name="purchaseDate" required>
                    </div>
                    <div class="form-group">
                        <label id="purchaseQtyLabel">📊 Qty / Number of Units:</label>
                        <input type="number" name="credits" min="1" max="10000" required placeholder="e.g., 5">
                        <small id="purchaseQtyHelp">For hardware, enter number of units. For services, enter number of months.</small>
                    </div>
                    <div class="form-group">
                        <label>💰 Total Cost in USD ($):</label>
                        <input type="number" name="priceUSD" step="0.01" min="0" required placeholder="0.00">
                        <small>Convert from other currencies to USD for consistent tracking</small>
                    </div>
                    <div class="form-group">
                        <label>📝 Notes:</label>
                        <textarea name="notes" rows="2" maxlength="500" placeholder="Exchange rates, payment method, additional notes..."></textarea>
                    </div>
                    <button type="submit" class="btn-primary">💸 Record Purchase & Add Stock</button>
                </form>

                <!-- Recent Purchases -->
                <h4>📦 Recent Inventory Purchases</h4>
                <div id="recentPurchasesList" class="transactions-list"></div>
            </div>
        </div>

        <!-- Business Management Tab -->
        <div id="business" class="tab-content">
            <h2>💼 Business Management</h2>

            <div class="business-forms">
                <div class="form-section">
                    <h3>💰 Add Money to Business</h3>
                    <form onsubmit="addBusinessMoney(event)" class="form">
                        <div class="form-group">
                            <label>💵 Amount ($):</label>
                            <input type="number" name="amount" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>📅 Date:</label>
                            <input type="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label>📝 Description:</label>
                            <input type="text" name="description" maxlength="200" placeholder="Source of money">
                        </div>
                        <button type="submit" class="btn-success">Add Money</button>
                    </form>
                </div>

                <div class="form-section">
                    <h3>💸 Withdraw Money from Business</h3>
                    <form onsubmit="withdrawBusinessMoney(event)" class="form">
                        <div class="form-group">
                            <label>💵 Amount ($):</label>
                            <input type="number" name="amount" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>📅 Date:</label>
                            <input type="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label>📝 Description:</label>
                            <input type="text" name="description" maxlength="200" placeholder="Purpose of withdrawal">
                        </div>
                        <button type="submit" class="btn-danger">Withdraw Money</button>
                    </form>
                </div>
            </div>

            <h3>📊 Business Transactions History</h3>
            <div id="businessTransactionsList" class="transactions-list"></div>
        </div>

        <!-- Transaction History Tab -->
        <div id="transactions" class="tab-content">
            <h2>📊 Transaction History</h2>

            <div class="transaction-controls" style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                <div class="tab-buttons" style="display: flex; gap: 10px;">
                    <button class="tab-button active" onclick="showTransactionTab('customer-sales')">👤 Customer Sales</button>
                    <button class="tab-button" onclick="showTransactionTab('vendor-purchases')">🏭 Vendor Purchases</button>
                </div>

                <div class="filters" style="display: flex; gap: 10px; margin-left: auto; align-items: center;">
                    <select id="transFilterMonth" onchange="TransactionUI.applyFilters()" class="form-select" style="padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <option value="all">All Months</option>
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>

                    <select id="transFilterYear" onchange="TransactionUI.applyFilters()" class="form-select" style="padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <!-- Will be populated by JS, including YTD and Last 12 Months -->
                    </select>

                    <div class="search-bar" style="width: 250px;">
                        <input type="text" id="transactionSearch" placeholder="🔍 Search..." 
                               oninput="TransactionUI.applyFilters()">
                        <button onclick="TransactionUI.clearTransactionSearch()" class="btn-clear" style="padding: 8px 12px;">✕</button>
                    </div>
                </div>
            </div>

            <div id="vendor-purchases" class="transaction-tab-content">
                <h3>Vendor Credit Purchases</h3>
                <div id="vendorTransactionsList" class="transactions-list"></div>
                <div id="vendorPagination" class="pagination-controls" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px; align-items: center;"></div>
            </div>

            <div id="customer-sales" class="transaction-tab-content active">
                <h3>Customer Sales</h3>
                <div id="customerSalesList" class="transactions-list"></div>
                <div id="customerPagination" class="pagination-controls" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px; align-items: center;"></div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>⚙️ System Settings</h2>
            
            <div class="customer-tabs">
                <button class="tab-button active" onclick="showSettingsTab('app-settings')">🖥️ App Settings</button>
                <button class="tab-button" onclick="showSettingsTab('receipt-settings')">🧾 Receipt Settings</button>
                <button class="tab-button" onclick="showSettingsTab('db-settings')">🗄️ Database</button>
            </div>

            <!-- App Settings -->
            <div id="app-settings" class="settings-section active">
                <form onsubmit="saveAppSettings(event)" class="form">
                    <div class="form-group">
                        <label>🏢 Company Name:</label>
                        <input type="text" id="settingCompanyName" required placeholder="Your Business Name">
                    </div>
                    
                    <div class="form-group">
                        <label>🖼️ Company Logo:</label>
                        <div style="display: flex; gap: 20px; align-items: flex-start;">
                            <div id="logoPreviewContainer" style="width: 150px; height: 150px; border: 2px dashed #cbd5e0; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #f8fafc; overflow: hidden;">
                                <img id="logoPreview" style="max-width: 100%; max-height: 100%; display: none;">
                                <span id="logoPlaceholder" style="color: #a0aec0; font-size: 12px; text-align: center;">No Logo<br>Selected</span>
                            </div>
                            <div style="flex: 1;">
                                <input type="file" id="settingLogoFile" accept="image/*" onchange="SettingsUI.previewLogo(event)" style="margin-bottom: 10px;">
                                <small>Upload your logo (PNG/JPG). It will appear on all receipts and the dashboard.</small>
                                <button type="button" onclick="SettingsUI.clearLogo()" class="btn-small btn-danger" style="display: block; margin-top: 10px;">Remove Logo</button>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">💾 Save App Settings</button>
                </form>
            </div>

            <!-- Receipt Settings -->
            <div id="receipt-settings" class="settings-section" style="display: none;">
                <form onsubmit="saveReceiptSettings(event)" class="form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div class="settings-column">
                            <h3>🏪 Business Details</h3>
                            <div class="form-group">
                                <label>📧 Business Email:</label>
                                <input type="email" id="settingCompanyEmail" placeholder="support@yourbusiness.com">
                            </div>
                            <div class="form-group">
                                <label>📱 Business Phone:</label>
                                <input type="tel" id="settingCompanyPhone" placeholder="+1 (555) 000-0000">
                            </div>
                            <div class="form-group">
                                <label>🏠 Business Address:</label>
                                <textarea id="settingCompanyAddress" rows="2" placeholder="123 Business St, City, State"></textarea>
                            </div>
                        </div>
                        
                        <div class="settings-column">
                            <h3>🧾 Invoice Branding</h3>
                            <div class="form-group">
                                <label>📝 Footer Instructions (Terms):</label>
                                <textarea id="settingReceiptInstructions" rows="4" placeholder="Enter warranty info, return policy, etc..."></textarea>
                                <small>Appears at the very bottom of the receipt.</small>
                            </div>
                            <div class="form-group">
                                <label>💰 Currency Symbol:</label>
                                <input type="text" id="settingCurrency" value="$" maxlength="5" style="width: 80px;">
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button type="submit" class="btn-primary">💾 Save Receipt Settings</button>
                        <button type="button" onclick="SettingsUI.showLivePreview()" class="btn-secondary">👁️ Preview Receipt Style</button>
                    </div>
                </form>
            </div>

            <!-- Database Settings -->
            <div id="db-settings" class="settings-section" style="display: none;">
                
                <!-- Danger Zone -->
                <div style="margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; background: #fff5f5; padding: 15px; border-radius: 8px; border: 1px solid #feb2b2;">
                    <h3 style="margin-top: 0; color: #c53030;">⚠️ Danger Zone</h3>
                    <p style="color: #742a2a; margin-bottom: 15px;">Resetting the database will permanently delete all customers, transactions, inventory, and history. This cannot be undone.</p>
                    <button onclick="SettingsUI.resetDatabase()" class="btn-danger">🗑️ Reset Database (Clear All Data)</button>
                </div>

                <div style="display: flex; gap: 20px; height: 600px;">
                    <!-- Sidebar: Table List -->
                    <div style="width: 250px; border-right: 1px solid #e2e8f0; padding-right: 20px; overflow-y: auto;">
                        <h3 style="margin-top: 0;">📋 Tables</h3>
                        <div id="dbTableList" class="db-table-list">
                            <div class="loading-message">Loading tables...</div>
                        </div>
                    </div>

                    <!-- Main Content: Data & Query -->
                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        
                        <!-- Query Box -->
                        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e2e8f0;">
                            <h3 style="margin-top: 0;">⌨️ SQL Execution</h3>
                            <div style="display: flex; gap: 10px;">
                                <textarea id="dbSqlInput" rows="3" style="flex: 1; font-family: monospace; padding: 10px;" placeholder="SELECT * FROM customers WHERE..."></textarea>
                                <button onclick="DBSettingsUI.executeQuery()" class="btn-primary" style="height: auto;">▶️ Run</button>
                            </div>
                        </div>

                        <!-- Data Grid -->
                        <div style="flex: 1; overflow: auto;">
                            <h3 style="margin-top: 0; display: flex; justify-content: space-between; align-items: center;">
                                <span id="dbCurrentTableName">📊 Data View</span>
                                <small id="dbRowCount" style="color: #718096; font-weight: normal;"></small>
                            </h3>
                            <div id="dbDataGrid" class="db-data-grid">
                                <div class="placeholder-text">Select a table to view data</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts in dependency order -->
    <!-- Load scripts in dependency order -->
    <script src="js/utils/formatters.js"></script>
    <script src="js/utils/validators.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/print.js"></script>
    <script src="js/state/store.js"></script>
    <script src="js/api/customers.js"></script>
    <script src="js/api/vendors.js"></script>
    <script src="js/api/subscriptions.js"></script>
    <script src="js/api/credits.js"></script>
    <script src="js/api/business.js"></script>
    <script src="js/api/pnl.js"></script>
    <script src="js/api/settings.js"></script>
    <script src="js/ui/alerts.js"></script>
    <script src="js/ui/dashboard.js"></script>
    <script src="js/ui/tabs.js"></script>
    <script src="js/ui/forms.js"></script>
    <script src="js/ui/receipts.js"></script>
    <script src="js/ui/vendors.js"></script>
    <script src="js/ui/transactions.js"></script>
    <script src="js/ui/reports.js"></script>
    <script src="js/ui/credits.js"></script>
    <script src="js/ui/business.js"></script>
    <script src="js/ui/customers.js"></script>
    <script src="js/ui/customer-profile.js?v=2"></script>
    <script src="js/ui/pos.js"></script>
    <script src="js/ui/support.js"></script>
    <script src="js/ui/settings.js"></script>
    <script src="js/ui/db-settings.js"></script>
    <script src="js/app.js"></script>

</body>
</html>
